// APIErrorCode represents an API error code and its corresponding HTTP error code
type APIErrorCode interface {
    // HTTPStatus returns the HTTP status code
	HTTPStatus() int
    // AppCode returns the application error code
	AppCode() string
}

// TestClient is a client that is used mainly for testing.
type TestClient struct {
    // The generated client.
    Client ClientInterface
}

{{/* Generate client methods */}}
{{range . -}}
{{$hasParams := .RequiresParamObject -}}
{{$pathParams := .PathParams -}}
{{$opid := .OperationId -}}
{{$op := . -}}

// {{$opid}}{{if .HasBody}}WithBody{{end}} calls the endpoints, asserts that there are no errors, and return the TestResponse.
func (tc *TestClient) {{$opid}}{{if .HasBody}}WithBody{{end}}(tb testing.TB{{genParamArgs $pathParams}}{{if $hasParams}}, params *{{$opid}}Params{{end}}{{if .HasBody}}, contentType string, body io.Reader{{end}}, reqEditors... RequestEditorFn) *{{$opid}}TestResponse {
    ctx := context.Background()
    resp, err := tc.Client.{{$opid}}{{if .HasBody}}WithBody{{end}}(ctx{{genParamNames $pathParams}}{{if $hasParams}}, params{{end}}{{if .HasBody}}, contentType, body{{end}}, reqEditors...)
    if err != nil {
        tb.Fatal(err)
    }
    return &{{$opid}}TestResponse{resp, tb, tc}
}

{{range .Bodies}}
// {{$opid}}{{.Suffix}} calls the endpoints, asserts that there are no errors, and return the TestResponse.
func (tc *TestClient) {{$opid}}{{.Suffix}}(tb testing.TB{{genParamArgs $pathParams}}{{if $hasParams}}, params *{{$opid}}Params{{end}}, body {{$opid}}{{.NameTag}}RequestBody, reqEditors... RequestEditorFn) *{{$opid}}TestResponse {
    ctx := context.Background()
    resp, err := tc.Client.{{$opid}}{{.Suffix}}(ctx{{genParamNames $pathParams}}{{if $hasParams}}, params{{end}}, body, reqEditors...)
    if err != nil {
        tb.Fatal(err)
    }
    return &{{$opid}}TestResponse{resp, tb, tc}
}
{{end}}{{/* range .Bodies */}}

{{/* Response handlers */}}
// {{$opid}}TestResponse provides a facility for asserting response bodies.
type {{$opid}}TestResponse struct {
    *http.Response

    tb testing.TB
    tc *TestClient
}

{{ if $op.HasEmptySuccess }}
// OK asserts a successful response with no body.
func (c *{{$op.OperationId}}TestResponse) OK() {
    if c.StatusCode != 200 {
        c.tb.Fatalf("Expected status code 200, got %d", c.StatusCode)
    }
    if c.ContentLength != 0 {
        c.tb.Fatalf("Expected zero content length, got %d", c.ContentLength)
    }
}
{{- end }}
{{- range .GetResponseIndependentTypeDefinitions }}
{{ $respType := .TypeName }}
{{- if or (eq .ResponseName "1XX") (eq .ResponseName "2XX") (eq .ResponseName "3XX") }}
// Respond{{.ResponseName}} asserts a response with the given code in range and the defined JSON type.
func (c *{{$op.OperationId}}TestResponse) Respond{{.ResponseName}}(code int) {{$respType}} {
    if c.StatusCode != code {
        c.tb.Fatalf("Expected status code %d, got %d", code, c.StatusCode)
    }
    var resp {{$respType}}
    c.tc.parseJSONResponse(c.tb, c.Response, &resp)
    return resp
}
{{- else if or (eq .ResponseName "4XX") (eq .ResponseName "5XX") }}
// Error{{.ResponseName}} asserts an error response with the given API error code
func (c *{{$op.OperationId}}TestResponse) Error{{.ResponseName}}(code APIErrorCode) {{$respType}} {
    if c.StatusCode != code.HTTPStatus() {
        c.tb.Fatalf("Expected status code %d, got %d", code.HTTPStatus(), c.StatusCode)
    }
    var resp {{$respType}}
    c.tc.parseJSONResponse(c.tb, c.Response, &resp)

    if resp.Code != code.AppCode() {
        c.tb.Fatalf("Expected error code %s, got %s", code.AppCode(), resp.Code)
    }

    return resp
}
{{- else if (ne .ResponseName "default") }}
{{ $respName := statusText .ResponseName | camelCase | title }}
// {{$respName}} asserts a response with the appropriate code and the defined JSON type.
func (c *{{$op.OperationId}}TestResponse) {{$respName}}() {{$respType}} {
    if c.StatusCode != {{.ResponseName}} {
        c.tb.Fatalf("Expected status code {{.ResponseName}}, got %d", c.StatusCode)
    }
    var resp {{$respType}}
    c.tc.parseJSONResponse(c.tb, c.Response, &resp)
    return resp
}
{{- end }}
{{- end }}
{{end}}

func (tc *TestClient) parseJSONResponse(tb testing.TB, resp *http.Response, target validation.Validatable) {
    defer resp.Body.Close()
    decoder := json.NewDecoder(resp.Body)
    if err := decoder.Decode(target); err != nil {
        tb.Fatalf("Failed to decode response body as JSON: %v", err)
    }
    if err := target.Validate(); err != nil {
        tb.Fatalf("Response validation failed: %v", err)
    }
}
